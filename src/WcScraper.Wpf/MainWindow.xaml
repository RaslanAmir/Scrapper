
<Window x:Class="WcScraper.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:models="clr-namespace:WcScraper.Wpf.Models"
        xmlns:controls="clr-namespace:WcScraper.Wpf.Views.Controls"
        mc:Ignorable="d"
        Title="WC Local Scraper (WPF)" Height="580" Width="900"
        DataContextChanged="OnMainWindowDataContextChanged">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
        <Style x:Key="CredentialDependentCheckBoxStyle" TargetType="CheckBox">
            <Setter Property="ToolTip" Value="{x:Null}" />
            <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="ToolTip" Value="Requires WordPress admin username and application password." />
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <Grid Margin="0,0,0,12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Platform selection -->
                <GroupBox Grid.Row="0" Grid.ColumnSpan="3" Header="Platform" Margin="0,0,0,8">
                    <StackPanel Orientation="Horizontal" Margin="8,4,0,4">
                        <RadioButton Content="WooCommerce" IsChecked="{Binding IsWooCommerce, Mode=TwoWay}" Margin="0,0,16,0"/>
                        <RadioButton Content="Shopify" IsChecked="{Binding IsShopify, Mode=TwoWay}"/>
                    </StackPanel>
                </GroupBox>

                <!-- URL + Run -->
                <TextBlock Grid.Row="1" Text="{Binding StoreUrlLabel}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding StoreUrl, UpdateSourceTrigger=PropertyChanged}" MinWidth="520"
                         Visibility="{Binding IsWooCommerce, Converter={StaticResource BoolToVisibility}}" />
                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding ShopifyStoreUrl, UpdateSourceTrigger=PropertyChanged}" MinWidth="520"
                         Visibility="{Binding IsShopify, Converter={StaticResource BoolToVisibility}}" />
                <StackPanel Grid.Row="1" Grid.Column="2" Orientation="Horizontal" Margin="8,0,0,0">
                    <Button Content="Run" Padding="16,6" Command="{Binding RunCommand}" />
                    <Button Content="AI Setup Wizard"
                            Margin="8,0,0,0"
                            Padding="12,6"
                            Command="{Binding LaunchWizardCommand}"/>
                </StackPanel>

                <!-- Output -->
                <TextBlock Grid.Row="2" Text="Output folder:" VerticalAlignment="Center" Margin="0,8,8,0"/>
                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding OutputFolder, UpdateSourceTrigger=PropertyChanged}" />
                <Button Grid.Row="2" Grid.Column="2" Content="Browse…" Margin="8,8,0,0" Padding="12,6" Command="{Binding BrowseCommand}" />

                <GroupBox Grid.Row="3" Grid.ColumnSpan="3" Header="WooCommerce Credentials" Margin="0,12,0,0">
                    <GroupBox.DataContext>
                        <Binding Path="WooCommerce" />
                    </GroupBox.DataContext>
                    <GroupBox.Visibility>
                        <Binding Path="IsWooCommerce" Converter="{StaticResource BoolToVisibility}" />
                    </GroupBox.Visibility>
                    <controls:WooCommerceCredentialsControl />
                </GroupBox>

        <!-- Shopify credentials -->
        <GroupBox Grid.Row="3" Grid.ColumnSpan="3" Header="Shopify Credentials" Margin="0,12,0,0">
            <GroupBox.DataContext>
                <Binding Path="Shopify" />
            </GroupBox.DataContext>
            <GroupBox.Visibility>
                <Binding Path="IsShopify" Converter="{StaticResource BoolToVisibility}" />
            </GroupBox.Visibility>
            <controls:ShopifyCredentialsControl />
        </GroupBox>

        <!-- Exports -->
        <GroupBox Grid.Row="4" Grid.ColumnSpan="3" Header="Exports" Margin="0,12,0,8">
            <GroupBox.DataContext>
                <Binding Path="ExportOptions" />
            </GroupBox.DataContext>
            <controls:ExportOptionsControl />
        </GroupBox>

        <!-- Provisioning -->
        <GroupBox Grid.Row="5" Grid.ColumnSpan="3" Header="Provisioning (WooCommerce target)" Margin="0,12,0,8">
            <StackPanel Margin="8">
                <TextBlock Text="Target base URL:" Margin="0,0,0,4"/>
                <TextBox Text="{Binding Provisioning.TargetStoreUrl, UpdateSourceTrigger=PropertyChanged}" MinWidth="320"/>
                <TextBlock Text="Consumer key:" Margin="0,8,0,4"/>
                <TextBox Text="{Binding Provisioning.TargetConsumerKey, UpdateSourceTrigger=PropertyChanged}"/>
                <TextBlock Text="Consumer secret:" Margin="0,8,0,4"/>
                <TextBox Text="{Binding Provisioning.TargetConsumerSecret, UpdateSourceTrigger=PropertyChanged}"/>
                <TextBlock Text="Run an export, then configure the target WooCommerce REST credentials and click Replicate store." TextWrapping="Wrap" Margin="0,12,0,8"/>
                <CheckBox Content="Apply captured store configuration before provisioning"
                          IsChecked="{Binding Provisioning.ImportStoreConfiguration}"
                          Margin="0,0,0,4"/>
                <TextBlock Text="Requires an export with store configuration enabled and WordPress credentials."
                           TextWrapping="Wrap"
                           Margin="0,0,0,8"/>
                <TextBlock Text="{Binding Provisioning.CanReplicate, StringFormat=Export ready: {0}}" Margin="0,0,0,4"/>
                <Button Content="Replicate store" HorizontalAlignment="Right" Padding="16,6" Command="{Binding Provisioning.ReplicateCommand}" />
            </StackPanel>
        </GroupBox>

        <!-- Filters -->
        <GroupBox Grid.Row="6" Grid.ColumnSpan="3" Header="Filters (optional)">
            <GroupBox.DataContext>
                <Binding Path="Filters" />
            </GroupBox.DataContext>
            <controls:FilterOptionsControl />
        </GroupBox>

        <Expander Grid.Row="7"
                  Grid.ColumnSpan="3"
                  Header="AI Assistant"
                  Margin="0,12,0,8"
                  IsExpanded="{Binding ChatAssistant.IsAssistantPanelExpanded, Mode=TwoWay}">
            <Border Padding="8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="280"/>
                        <ColumnDefinition Width="12"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="API endpoint:" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding ChatAssistant.ChatApiEndpoint, UpdateSourceTrigger=PropertyChanged}" Margin="0,4,0,0"/>
                        <TextBlock Text="Model / deployment:" Margin="0,12,0,0" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding ChatAssistant.ChatModel, UpdateSourceTrigger=PropertyChanged}" Margin="0,4,0,0"/>
                        <TextBlock Text="API key:" Margin="0,12,0,0" FontWeight="SemiBold"/>
                        <PasswordBox x:Name="ChatApiKeyBox"
                                     Margin="0,4,0,0"
                                     PasswordChanged="OnChatApiKeyChanged"/>
                        <TextBlock Text="{Binding ChatAssistant.HasChatApiKey, StringFormat=Key stored: {0}}"
                                   Foreground="Gray"
                                   Margin="0,4,0,0"/>
                        <TextBlock Text="System prompt (optional):" Margin="0,12,0,0" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding ChatAssistant.ChatSystemPrompt, UpdateSourceTrigger=PropertyChanged}"
                                AcceptsReturn="True"
                                TextWrapping="Wrap"
                                 Height="120"
                                 VerticalScrollBarVisibility="Auto"
                                 Margin="0,4,0,0"/>
                        <TextBlock Text="Run goals for AI brief (optional):"
                                   Margin="0,12,0,0"
                                   FontWeight="SemiBold"/>
                        <TextBox Text="{Binding ManualRunGoals, UpdateSourceTrigger=PropertyChanged}"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 Height="80"
                                 VerticalScrollBarVisibility="Auto"
                                 Margin="0,4,0,0"/>
                    </StackPanel>
                    <TabControl Grid.Column="2">
                        <TabItem Header="Chat">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <StackPanel Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Mode:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    <ComboBox ItemsSource="{Binding ChatAssistant.ChatModeOptions}"
                                              SelectedValue="{Binding ChatAssistant.SelectedChatMode, Mode=TwoWay}"
                                              SelectedValuePath="Mode"
                                              DisplayMemberPath="Label"
                                              Width="220"
                                              Margin="12,0,0,0"/>
                                </StackPanel>
                                <TextBlock Grid.Row="1"
                                           Text="{Binding ChatAssistant.ChatStatusMessage}"
                                           FontWeight="SemiBold"
                                           TextWrapping="Wrap"
                                           Margin="0,8,0,0"/>
                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,0" HorizontalAlignment="Left">
                                    <TextBlock Text="{Binding ChatAssistant.TotalPromptTokens, StringFormat=Prompt tokens: {0:N0}}" />
                                    <TextBlock Text="{Binding ChatAssistant.TotalCompletionTokens, StringFormat=Completion tokens: {0:N0}}" Margin="16,0,0,0" />
                                    <TextBlock Text="{Binding ChatAssistant.ChatTotalTokenTotal, StringFormat=Total tokens: {0:N0}}" Margin="16,0,0,0" />
                                    <TextBlock Text="{Binding ChatAssistant.TotalCostUsd, StringFormat=Cost: ${0:F2}}" Margin="16,0,0,0" />
                                </StackPanel>
                                <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,8,0,0" VerticalAlignment="Center">
                                    <TextBlock Text="Prompt budget:" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    <TextBox Width="100"
                                             Margin="8,0,0,0"
                                             HorizontalContentAlignment="Right"
                                             Text="{Binding ChatAssistant.ChatMaxPromptTokens, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Stop sending new requests after this many prompt tokens are consumed. Leave blank to disable the prompt-token budget."/>
                                    <TextBlock Text="Total budget:" Margin="16,0,0,0" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    <TextBox Width="100"
                                             Margin="8,0,0,0"
                                             HorizontalContentAlignment="Right"
                                             Text="{Binding ChatAssistant.ChatMaxTotalTokens, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Stop sending new requests after this many total tokens are consumed. Leave blank to disable the total-token budget."/>
                                    <TextBlock Text="Cost budget (USD):" Margin="16,0,0,0" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    <TextBox Width="90"
                                             Margin="8,0,0,0"
                                             HorizontalContentAlignment="Right"
                                             Text="{Binding ChatAssistant.ChatMaxCostUsd, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Stop sending new requests after this amount is spent. Leave blank to disable the cost budget."/>
                                </StackPanel>
                                <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="0,8,0,0" HorizontalAlignment="Right">
                                    <Button Content="Save transcript"
                                            Command="{Binding ChatAssistant.SaveChatTranscriptCommand}"
                                            Padding="12,4"/>
                                    <Button Content="Clear history"
                                            Command="{Binding ChatAssistant.ClearChatHistoryCommand}"
                                            Padding="12,4"
                                            Margin="8,0,0,0"/>
                                </StackPanel>
                                <Border Grid.Row="5" BorderBrush="#FFD9D9D9" BorderThickness="1" Padding="8" Margin="0,8,0,8">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                        <ItemsControl ItemsSource="{Binding ChatAssistant.ChatMessages}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type models:ChatMessage}">
                                                    <Border Margin="0,4,0,4" Padding="8">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Background" Value="#FFF7F7F9"/>
                                                                <Setter Property="CornerRadius" Value="6"/>
                                                                <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Role}" Value="{x:Static models:ChatMessageRole.User}">
                                                                        <Setter Property="Background" Value="#FFE6F7FF"/>
                                                                        <Setter Property="HorizontalAlignment" Value="Right"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Role}" Value="{x:Static models:ChatMessageRole.Assistant}">
                                                                        <Setter Property="Background" Value="#FFF3F0FF"/>
                                                                        <Setter Property="HorizontalAlignment" Value="Left"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding Role}" FontWeight="Bold"/>
                                                            <TextBlock Text="{Binding Content}" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                                <TextBox Grid.Row="6"
                                         Text="{Binding ChatAssistant.ChatInput, UpdateSourceTrigger=PropertyChanged}"
                                         AcceptsReturn="True"
                                         Height="80"
                                         TextWrapping="Wrap"
                                         VerticalScrollBarVisibility="Auto"
                                         Margin="0,0,0,8"/>
                                <StackPanel Grid.Row="7" Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="Send"
                                            Command="{Binding ChatAssistant.SendChatCommand}"
                                            Padding="16,6"/>
                                    <Button Content="Cancel response"
                                            Command="{Binding ChatAssistant.CancelChatCommand}"
                                            Padding="12,6"
                                            Margin="8,0,0,0"
                                            Visibility="{Binding ChatAssistant.IsChatBusy, Converter={StaticResource BoolToVisibility}}"/>
                                </StackPanel>
                            </Grid>
                        </TabItem>
                        <TabItem Header="Automation scripts">
                            <Grid Margin="0,8,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0"
                                           Text="Automation helpers save WP-CLI, REST, or shell commands to manual-migration-scripts/ after each run."
                                           TextWrapping="Wrap"
                                           Foreground="Gray"/>
                                <TextBlock Grid.Row="1"
                                           Text="{Binding LatestAutomationScriptSummary}"
                                           TextWrapping="Wrap"
                                           Margin="0,8,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasAutomationScriptSummary}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <TextBlock Grid.Row="2"
                                           Text="{Binding LatestAutomationScriptError}"
                                           TextWrapping="Wrap"
                                           Foreground="DarkRed"
                                           Margin="0,8,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasAutomationScriptError}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                                <ItemsControl Grid.Row="3"
                                              ItemsSource="{Binding LatestAutomationScriptWarnings}"
                                              Margin="0,8,0,0">
                                    <ItemsControl.Style>
                                        <Style TargetType="ItemsControl">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasAutomationScriptWarnings}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ItemsControl.Style>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="⚠️  {Binding}" TextWrapping="Wrap" Margin="0,2,0,0"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <Border Grid.Row="4" BorderBrush="#FFD9D9D9" BorderThickness="1" Padding="8" Margin="0,8,0,0">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                        <StackPanel>
                                            <TextBlock Text="No automation scripts yet."
                                                       FontStyle="Italic"
                                                       Foreground="Gray">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasAutomationScripts}" Value="True">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <ItemsControl ItemsSource="{Binding LatestAutomationScripts}">
                                                <ItemsControl.Style>
                                                    <Style TargetType="ItemsControl">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding HasAutomationScripts}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ItemsControl.Style>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Margin="0,0,0,12" Padding="8" BorderBrush="#FFD9D9D9" BorderThickness="1" CornerRadius="6">
                                                            <StackPanel>
                                                                <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                                                <TextBlock Text="{Binding Description}"
                                                                           TextWrapping="Wrap"
                                                                           Margin="0,4,0,0">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding Description}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding Description}" Value="">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                                <StackPanel Margin="0,4,0,0">
                                                                    <TextBlock Text="{Binding Language, StringFormat=Language: {0}}"/>
                                                                    <TextBlock Text="{Binding RelativePath, StringFormat=Saved to: {0}}"
                                                                               FontStyle="Italic"
                                                                               Foreground="Gray"
                                                                               Margin="0,2,0,0"/>
                                                                </StackPanel>
                                                                <ItemsControl ItemsSource="{Binding Notes}" Margin="0,4,0,0">
                                                                    <ItemsControl.Style>
                                                                        <Style TargetType="ItemsControl">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding Notes.Count}" Value="0">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </ItemsControl.Style>
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate>
                                                                            <TextBlock Text="•  {Binding}" TextWrapping="Wrap" Margin="0,2,0,0"/>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                                <Button Content="Copy script"
                                                                        Command="{Binding DataContext.CopyAutomationScriptCommand, RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                                        CommandParameter="{Binding}"
                                                                        HorizontalAlignment="Left"
                                                                        Padding="12,4"
                                                                        Margin="0,8,0,0"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </ScrollViewer>
                                </Border>
                            </Grid>
                        </TabItem>
                        <TabItem Header="Run plans">
                            <Grid Margin="0,8,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0"
                                           Text="Assistant remediation plans appear when the assistant queues follow-up runs."
                                           TextWrapping="Wrap"
                                           Foreground="Gray"/>
                                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                                    <StackPanel>
                                        <TextBlock Text="No run plans yet."
                                                   FontStyle="Italic"
                                                   Foreground="Gray"
                                                   Margin="0,4,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ExportPlanning.HasRunPlans}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <ItemsControl ItemsSource="{Binding ExportPlanning.RunPlans}" Margin="0,4,0,0">
                                            <ItemsControl.Style>
                                                <Style TargetType="ItemsControl">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ExportPlanning.HasRunPlans}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ItemsControl.Style>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type models:RunPlan}">
                                                    <Border Margin="0,0,0,12" Padding="8" BorderBrush="#FFD9D9D9" BorderThickness="1" CornerRadius="6">
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                                            <TextBlock Text="{Binding DirectiveSummary}"
                                                                       TextWrapping="Wrap"
                                                                       Margin="0,4,0,0">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding DirectiveSummary}" Value="{x:Null}">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding DirectiveSummary}" Value="">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <StackPanel Margin="0,4,0,0">
                                                                <TextBlock Text="{Binding Status, StringFormat=Status: {0}}" FontWeight="SemiBold"/>
                                                                <TextBlock Text="{Binding CreatedAtUtc, StringFormat=Created: {0:O} (UTC)}"/>
                                                                <TextBlock Text="{Binding ExecutionOrder, StringFormat=Execution order: {0}}">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding ExecutionOrder}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                                <TextBlock Text="{Binding ScheduledForUtc, StringFormat=Scheduled: {0:O} (UTC)}">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding ScheduledForUtc}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                                <TextBlock Text="Scheduled: Awaiting approval">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding ScheduledForUtc}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                                <TextBlock Text="{Binding ExecutedAtUtc, StringFormat=Executed: {0:O} (UTC)}" Margin="0,2,0,0">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding ExecutedAtUtc}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                                <TextBlock Text="{Binding ResultNote, StringFormat=Result: {0}}" TextWrapping="Wrap" Margin="0,2,0,0">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding ResultNote}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding ResultNote}" Value="">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                            </StackPanel>
                                                            <TextBlock Text="Overrides:" FontWeight="SemiBold" Margin="0,8,0,0">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Settings.Count}" Value="0">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <ItemsControl ItemsSource="{Binding Settings}" Margin="0,2,0,0">
                                                                <ItemsControl.Style>
                                                                    <Style TargetType="ItemsControl">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Settings.Count}" Value="0">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </ItemsControl.Style>
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <StackPanel Margin="0,1,0,0">
                                                                            <StackPanel Orientation="Horizontal">
                                                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                                                                <TextBlock Text=": " Margin="2,0,0,0"/>
                                                                                <TextBlock Text="{Binding DisplayValue}"/>
                                                                            </StackPanel>
                                                                            <TextBlock Text="{Binding Description}" Foreground="Gray" Margin="0,0,0,0">
                                                                                <TextBlock.Style>
                                                                                    <Style TargetType="TextBlock">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                        <Style.Triggers>
                                                                                            <DataTrigger Binding="{Binding Description}" Value="{x:Null}">
                                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                            </DataTrigger>
                                                                                            <DataTrigger Binding="{Binding Description}" Value="">
                                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                            </DataTrigger>
                                                                                        </Style.Triggers>
                                                                                    </Style>
                                                                                </TextBlock.Style>
                                                                            </TextBlock>
                                                                        </StackPanel>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                            <TextBlock Text="Prerequisites:" FontWeight="SemiBold" Margin="0,8,0,0">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding PrerequisiteNotes.Count}" Value="0">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <ItemsControl ItemsSource="{Binding PrerequisiteNotes}" Margin="0,2,0,0">
                                                                <ItemsControl.Style>
                                                                    <Style TargetType="ItemsControl">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding PrerequisiteNotes.Count}" Value="0">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </ItemsControl.Style>
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <TextBlock Text="•  {Binding}" TextWrapping="Wrap" Margin="0,1,0,0"/>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                                                <Button Content="Approve"
                                                                        Command="{Binding DataContext.ExportPlanning.ApproveRunPlanCommand, RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                                        CommandParameter="{Binding}"
                                                                        Padding="12,4"
                                                                        Margin="0,0,8,0"/>
                                                                <Button Content="Dismiss"
                                                                        Command="{Binding DataContext.ExportPlanning.DismissRunPlanCommand, RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                                        CommandParameter="{Binding}"
                                                                        Padding="12,4"/>
                                                            </StackPanel>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </ScrollViewer>
                            </Grid>
                        </TabItem>
                        <TabItem Header="AI recommendations">
                            <Grid Margin="0,8,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0"
                                           Text="Recommendations appear after a run when AI annotations are available."
                                           TextWrapping="Wrap"
                                           Foreground="Gray"/>
                                <Border Grid.Row="1" BorderBrush="#FFD9D9D9" BorderThickness="1" Padding="8" Margin="0,8,0,0">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                        <StackPanel>
                                            <TextBlock Text="No AI recommendations yet."
                                                       FontStyle="Italic"
                                                       Margin="0,0,0,8">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ChatAssistant.HasAiRecommendations}" Value="False">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <TextBlock Text="{Binding ChatAssistant.LatestRunAiAnnotationTimestamp, StringFormat=Generated at: {0:O}}"
                                                       Margin="0,0,0,8">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ChatAssistant.LatestRunAiAnnotationTimestamp}" Value="{x:Null}">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <TextBox Text="{Binding ChatAssistant.LatestRunAiRecommendationSummary, Mode=OneWay}"
                                                     IsReadOnly="True"
                                                     TextWrapping="Wrap"
                                                     AcceptsReturn="True"
                                                     BorderThickness="0"
                                                     Background="Transparent"
                                                     Margin="0,0,0,12">
                                                <TextBox.Style>
                                                    <Style TargetType="TextBox">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ChatAssistant.HasAiRecommendations}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBox.Style>
                                            </TextBox>
                                            <ItemsControl ItemsSource="{Binding ChatAssistant.LatestRunAiRecommendations}">
                                                <ItemsControl.Style>
                                                    <Style TargetType="ItemsControl">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ChatAssistant.HasAiRecommendations}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ItemsControl.Style>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type models:AiRecommendation}">
                                                        <Border Margin="0,0,0,12" Padding="8" BorderBrush="#FFD9D9D9" BorderThickness="1" CornerRadius="6">
                                                            <StackPanel>
                                                                <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                                                                <TextBlock Text="{Binding Summary}" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                                                <StackPanel Margin="0,8,0,0">
                                                                    <TextBlock Text="Related assets:" FontWeight="SemiBold">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding HasRelatedAssets}" Value="True">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>
                                                                    <ItemsControl ItemsSource="{Binding RelatedAssets}">
                                                                        <ItemsControl.Style>
                                                                            <Style TargetType="ItemsControl">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding HasRelatedAssets}" Value="True">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </ItemsControl.Style>
                                                                        <ItemsControl.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <TextBlock Text="•  {Binding}" TextWrapping="Wrap" Margin="0,2,0,0"/>
                                                                            </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                    </ItemsControl>
                                                                </StackPanel>
                                                                <StackPanel Margin="0,8,0,0">
                                                                    <TextBlock Text="Suggested follow-ups:" FontWeight="SemiBold">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding HasSuggestedPrompts}" Value="True">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>
                                                                    <ItemsControl ItemsSource="{Binding SuggestedPrompts}">
                                                                        <ItemsControl.Style>
                                                                            <Style TargetType="ItemsControl">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding HasSuggestedPrompts}" Value="True">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </ItemsControl.Style>
                                                                        <ItemsControl.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <Button Content="{Binding}"
                                                                                        Command="{Binding DataContext.ChatAssistant.UseAiRecommendationCommand, RelativeSource={RelativeSource AncestorType=TabItem}}"
                                                                                        CommandParameter="{Binding}"
                                                                                        Margin="0,4,0,0"
                                                                                        HorizontalAlignment="Left"/>
                                                                            </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                    </ItemsControl>
                                                                </StackPanel>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </ScrollViewer>
                                </Border>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </Grid>
            </Border>
        </Expander>
            </Grid>
        </ScrollViewer>

        <Grid Grid.Row="1">
            <StatusBar Margin="0,12,0,0">
                <StatusBarItem Content="{Binding Path=Logs.Count, StringFormat=Messages: {0}}" />
                <StatusBarItem>
                    <Button Content="Open Logs" Command="{Binding OpenLogCommand}" Padding="12,4" />
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="{Binding ChatAssistant.TotalPromptTokens, StringFormat=Prompt: {0:N0}}" />
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="{Binding ChatAssistant.TotalCompletionTokens, StringFormat=Completion: {0:N0}}" />
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="{Binding ChatAssistant.ChatTotalTokenTotal, StringFormat=Total: {0:N0}}" />
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="{Binding ChatAssistant.TotalCostUsd, StringFormat=Cost: ${0:F2}}" />
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="{Binding IsRunning, StringFormat=Running: {0}}" />
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="{Binding LatestLogSummaryStatus}" TextTrimming="CharacterEllipsis" ToolTip="{Binding LatestLogSummaryOverview}" />
                </StatusBarItem>
            </StatusBar>
        </Grid>
    </Grid>
</Window>
